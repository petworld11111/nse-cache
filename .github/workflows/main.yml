name: NSE Cache

on:
  schedule:
    - cron: "*/3 * * * *"
  workflow_dispatch:

jobs:
  fetch:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Fetch NSE Data via proxy
        run: |
          echo "Fetching NSE data via proxy..."
          curl -s \
            -H "User-Agent: Mozilla/5.0" \
            "https://api.allorigins.win/raw?url=https://www.nseindia.com/api/option-chain-indices?symbol=NIFTY" \
            > raw.json
          echo "Downloaded raw.json:"
          head -n 20 raw.json || true

      - name: Validate JSON
        run: |
          if ! node -e "JSON.parse(require('fs').readFileSync('raw.json'))" 2>/dev/null; then
            echo '{"error":"invalid JSON"}' > raw.json
          fi

      - name: Process JSON
        run: |
          node -e "
          const fs=require('fs');
          const raw = fs.readFileSync('raw.json','utf-8');
          let j;
          try { j = JSON.parse(raw); } catch(e){ j={records:{data:[],underlyingValue:0}}; }
          const r=j.records || {data:[],underlyingValue:0};
          let ce=0,pe=0;
          const strikes=[];
          r.data.forEach(d=>{
            if(d.CE) ce+=d.CE.openInterest||0;
            if(d.PE) pe+=d.PE.openInterest||0;
            strikes.push({
              strike:d.strikePrice,
              diff:(d.CE?.openInterest||0)-(d.PE?.openInterest||0)
            });
          });
          fs.writeFileSync('data.json',JSON.stringify({
            price:r.underlyingValue || 0,
            ceOI:ce,
            peOI:pe,
            gex:ce-pe,
            strikes,
            time:new Date().toISOString()
          },null,2));
          "

      - name: Commit
        run: |
          git config user.name "bot"
          git config user.email "bot@github.com"
          git add data.json
          git commit -m "update nse data" || echo "no change"
          git push
