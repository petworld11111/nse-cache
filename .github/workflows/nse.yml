name: NSE Cache

on:
  schedule:
    - cron: "*/3 * * * *"
  workflow_dispatch:

jobs:
  fetch:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Fetch NSE Data with retries
        run: |
          SUCCESS=0
          for i in {1..5}; do
            echo "Attempt $i..."
            curl -s \
              -H "User-Agent: Mozilla/5.0" \
              -H "Accept: application/json" \
              -H "Referer: https://www.nseindia.com/" \
              "https://www.nseindia.com/api/option-chain-indices?symbol=NIFTY" \
              > raw.json
            if grep -q "records" raw.json; then
              SUCCESS=1
              break
            fi
            echo "Failed, retrying in 5s..."
            sleep 5
          done
          if [ $SUCCESS -eq 0 ]; then
            echo "Failed to fetch NSE data after 5 attempts"
            exit 1
          fi

      - name: Process JSON
        run: |
          node -e "
          const fs=require('fs');
          const j=JSON.parse(fs.readFileSync('raw.json'));
          const r=j.records;
          let ce=0,pe=0;
          const strikes=[];
          r.data.forEach(d=>{
            if(d.CE) ce+=d.CE.openInterest||0;
            if(d.PE) pe+=d.PE.openInterest||0;
            strikes.push({
              strike:d.strikePrice,
              diff:(d.CE?.openInterest||0)-(d.PE?.openInterest||0)
            });
          });
          fs.writeFileSync('data.json',JSON.stringify({
            price:r.underlyingValue,
            ceOI:ce,
            peOI:pe,
            gex:ce-pe,
            strikes,
            time:new Date().toISOString()
          },null,2));
          "

      - name: Ensure data.json is not empty
        run: |
          if [ ! -s data.json ]; then
            echo '{"error":"data not fetched"}' > data.json
          fi

      - name: Commit
        run: |
          git config user.name "bot"
          git config user.email "bot@github.com"
          git add data.json
          git commit -m "update nse data" || echo "no change"
          git push
