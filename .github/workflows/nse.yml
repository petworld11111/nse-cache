name: NSE Cache

on:
  schedule:
    # Every 15 minutes (more polite to NSE servers)
    - cron: "*/15 * * * *"
  workflow_dispatch:

jobs:
  fetch:
    runs-on: ubuntu-latest

    steps:
      # 1️⃣ Checkout the repository
      - name: Checkout Repository
        uses: actions/checkout@v4

      # 2️⃣ Setup Node.js
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '20'

      # 3️⃣ Fetch NSE Data
      - name: Fetch NSE Data
        run: |
          set -e
          curl -s -H "User-Agent: Mozilla/5.0" \
                  -H "Accept: application/json" \
                  -H "Referer: https://www.nseindia.com/" \
                  "https://www.nseindia.com/api/option-chain-indices?symbol=NIFTY" \
                  -o raw.json

      # 4️⃣ Process JSON
      - name: Process JSON
        run: |
          node -e "
          const fs = require('fs');
          try {
            const j = JSON.parse(fs.readFileSync('raw.json'));
            const r = j.records;
            let ce = 0, pe = 0;
            const strikes = [];
            r.data.forEach(d => {
              if(d.CE) ce += d.CE.openInterest || 0;
              if(d.PE) pe += d.PE.openInterest || 0;
              strikes.push({
                strike: d.strikePrice,
                diff: (d.CE?.openInterest || 0) - (d.PE?.openInterest || 0)
              });
            });

            const output = {
              price: r.underlyingValue,
              ceOI: ce,
              peOI: pe,
              gex: ce - pe,
              strikes,
              time: new Date().toISOString()
            };

            // Save main data.json
            fs.writeFileSync('data.json', JSON.stringify(output, null, 2));

            // Save historical backup (optional)
            const dateStr = new Date().toISOString().replace(/[:.]/g, '-');
            const histFolder = 'history';
            if (!fs.existsSync(histFolder)) fs.mkdirSync(histFolder);
            fs.writeFileSync(`${histFolder}/data-${dateStr}.json`, JSON.stringify(output, null, 2));

          } catch(e) {
            console.error('Failed to process JSON:', e);
            process.exit(1);
          }
          "

      # 5️⃣ Commit changes
      - name: Commit & Push
        run: |
          git config user.name "bot"
          git config user.email "bot@github.com"
          git add data.json history/* || true
          git diff --cached --quiet || git commit -m "Update NSE data"
          git push
