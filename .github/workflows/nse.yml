name: NSE Cache

on:
  schedule:
    - cron: "*/3 * * * *"
  workflow_dispatch:

jobs:
  fetch:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Fetch NSE Data
        run: |
          curl -s \
          -H "User-Agent: Mozilla/5.0" \
          -H "Accept: application/json" \
          -H "Referer: https://www.nseindia.com/" \
          "https://www.nseindia.com/api/option-chain-indices?symbol=NIFTY" \
          > raw.json

      - name: Process JSON
        run: |
          node -e "
          const fs=require('fs');
          const j=JSON.parse(fs.readFileSync('raw.json'));
          const r=j.records;
          let ce=0,pe=0;
          const strikes=[];
          r.data.forEach(d=>{
            if(d.CE) ce+=d.CE.openInterest||0;
            if(d.PE) pe+=d.PE.openInterest||0;
            strikes.push({
              strike:d.strikePrice,
              diff:(d.CE?.openInterest||0)-(d.PE?.openInterest||0)
            });
          });
          fs.writeFileSync('data.json',JSON.stringify({
            price:r.underlyingValue,
            ceOI:ce,
            peOI:pe,
            gex:ce-pe,
            strikes,
            time:new Date().toISOString()
          },null,2));
          "

      - name: Commit
        run: |
          git config user.name "bot"
          git config user.email "bot@github.com"
          git add data.json
          git commit -m "update nse data" || echo "no change"
          git push
